<script src="https://deno.land/x/habitat/build/habitat-embed.js"></script>
<script>Habitat.install(this)</script>
<script>

const stage = Stage.make()

const {canvas, context} = stage

on.load(() => {
	
	document.body.style["margin"] = "0px"
	document.body.appendChild(canvas)
	trigger("resize")
	setInterval(stage.tick, 1000 / 60)
	
})

on.resize(() => {
	
	canvas.width = innerWidth
	canvas.height = innerHeight
	canvas.style["width"] = innerWidth
	canvas.style["height"] = innerHeight
	canvas.style["background-color"] = Colour.Black
	
})

const COLOURS = [
	Colour.Red,
	Colour.Green,
	Colour.Blue,
	//Colour.Pink,
	Colour.Yellow,
	Colour.Cyan,
	Colour.Orange,
	Colour.Purple,
]
	
const makeStar = () => {
	const colour = COLOURS[Math.floor(Math.random() * COLOURS.length)]
	const direction = Math.random() * 2*Math.PI
	return {colour, x: canvas.width/2, y: canvas.height/2, direction, speed: SPEED, speedMod: 0.95, age: 0}
}


const stars = new Set()
const MAX_STARS = Infinity
const SPEED = 5
const TRAIL_LENGTH = 100

const spawnStars = () => {
	if (Math.random() < 0.8 && stars.size < MAX_STARS) {
		const star = makeStar()
		stars.add(star)
		spawnStars()
	}
}

const MARGIN_TEST = 10

stage.tick = () => {
	context.clearRect(0, 0, canvas.width, canvas.height)
	
	spawnStars()
	
	context.lineCap = "round"
	for (const star of stars.values()) {
		
		context.strokeStyle = star.colour
		
		const tx = star.x + star.speed*TRAIL_LENGTH * Math.cos(star.direction)
		const ty = star.y + star.speed*TRAIL_LENGTH * Math.sin(star.direction)
			  
		const nx = star.x + star.speed * Math.cos(star.direction)
		const ny = star.y + star.speed * Math.sin(star.direction)
		
		context.lineWidth = star.age * 1.0
		context.beginPath()
		context.moveTo(star.x, star.y)
		context.lineTo(tx, ty)
		context.stroke()
		
		star.x = nx
		star.y = ny
		star.speed *= star.speedMod
		star.age += 0.6
		
		if (star.x < 0 || star.x > canvas.width || star.y < 0 || star.y > canvas.height) {
			stars.delete(star)
		}
		
		if (star.speed < 0.09) {
			stars.delete(star)
		}
	}
	
	//context.fillStyle = Colour.Grey
	//context.fillRect(canvas.width/MARGIN_TEST, canvas.height/MARGIN_TEST, canvas.width-canvas.width/MARGIN_TEST*2, canvas.height-canvas.height/MARGIN_TEST*2)
	
	
	
	
}




</script>
